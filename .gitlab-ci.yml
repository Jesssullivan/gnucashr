# GitLab CI/CD Pipeline for gnucashr R Package
# Primary CI pipeline - GitLab CI
# Optimized for speed with pak and Posit Package Manager

image: rocker/tidyverse:4.4.0

variables:
  R_LIBS_USER: "$CI_PROJECT_DIR/ci/lib"
  # Use Posit Package Manager for fast binary installs
  RSPM: "https://packagemanager.posit.co/cran/__linux__/jammy/latest"
  _R_CHECK_CRAN_INCOMING_REMOTE_: "false"
  _R_CHECK_FORCE_SUGGESTS_: "false"
  MAKEFLAGS: "-j4"
  # pak settings for faster installs
  PKG_SYSREQS: "true"
  PKG_SYSREQS_DRY_RUN: "false"

cache:
  key: "r-deps-v2-${CI_COMMIT_REF_SLUG}"
  paths:
    - $R_LIBS_USER
    - src/*.o
  policy: pull-push

stages:
  - check
  - test
  - coverage
  - deploy

# Optimized setup with pak
.setup: &setup
  before_script:
    - mkdir -p $R_LIBS_USER
    # System dependencies for Rcpp/RcppParallel/RcppArmadillo
    - apt-get update -qq && apt-get install -y -qq libcurl4-openssl-dev libssl-dev libxml2-dev libgit2-dev libblas-dev liblapack-dev
    # Install pak for fast dependency resolution
    - |
      Rscript -e '
        options(repos = c(RSPM = Sys.getenv("RSPM"), CRAN = "https://cloud.r-project.org"))
        if (!requireNamespace("pak", quietly = TRUE)) {
          install.packages("pak", repos = sprintf("https://r-lib.github.io/p/pak/stable/%s/%s/%s", .Platform$pkgType, R.Version()$os, R.Version()$arch))
        }
        pak::pkg_install("local::.", dependencies = TRUE, upgrade = FALSE)
      '

# R CMD check - the main package validation
r-cmd-check:
  stage: check
  timeout: 45m
  <<: *setup
  script:
    - |
      Rscript -e '
        options(repos = c(RSPM = Sys.getenv("RSPM"), CRAN = "https://cloud.r-project.org"))
        pak::pkg_install("rcmdcheck")
        rcmdcheck::rcmdcheck(
          args = c("--no-manual", "--as-cran", "--ignore-vignettes"),
          build_args = c("--no-manual", "--no-build-vignettes"),
          error_on = "error",
          check_dir = "check"
        )
      '
  artifacts:
    paths:
      - check/
    expire_in: 1 week
    when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Run testthat tests (can run in parallel with r-cmd-check via DAG)
test:
  stage: test
  timeout: 30m
  needs:
    - job: r-cmd-check
      optional: true
  <<: *setup
  script:
    - |
      Rscript -e '
        options(repos = c(RSPM = Sys.getenv("RSPM"), CRAN = "https://cloud.r-project.org"))
        pak::pkg_install("testthat")
        # Run tests from source directory with JUnit output
        results <- testthat::test_local(reporter = testthat::JunitReporter$new(file = "test-results.xml"))
        # Check for failures
        if (any(as.data.frame(results)$failed > 0)) {
          quit(status = 1)
        }
      '
  artifacts:
    reports:
      junit: test-results.xml
    expire_in: 1 week
    when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Code coverage with covr
coverage:
  stage: coverage
  timeout: 30m
  needs:
    - job: test
  <<: *setup
  script:
    - |
      Rscript -e '
        options(repos = c(RSPM = Sys.getenv("RSPM"), CRAN = "https://cloud.r-project.org"))
        pak::pkg_install("covr")

        cov <- covr::package_coverage(
          type = "tests",
          line_exclusions = list("src/RcppExports.cpp")
        )

        # Generate coverage report
        total_coverage <- covr::percent_coverage(cov)
        message(sprintf("Total coverage: %.1f%%", total_coverage))

        # Save coverage report as cobertura XML for GitLab
        covr::to_cobertura(cov, filename = "coverage.xml")

        # Upload to Codecov if token is available
        if (Sys.getenv("CODECOV_TOKEN") != "") {
          covr::codecov(token = Sys.getenv("CODECOV_TOKEN"))
        }
      '
  coverage: '/Total coverage: (\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Build pkgdown documentation site
pages:
  stage: deploy
  timeout: 20m
  needs:
    - job: r-cmd-check
  <<: *setup
  script:
    - |
      Rscript -e '
        options(repos = c(RSPM = Sys.getenv("RSPM"), CRAN = "https://cloud.r-project.org"))
        pak::pkg_install("pkgdown")
        pkgdown::build_site(override = list(destination = "public"))
      '
  artifacts:
    paths:
      - public
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  environment:
    name: production
    url: $CI_PAGES_URL

# CRAN-ready check (stricter, for releases)
cran-check:
  stage: check
  timeout: 1h
  <<: *setup
  script:
    - |
      Rscript -e '
        options(repos = c(RSPM = Sys.getenv("RSPM"), CRAN = "https://cloud.r-project.org"))
        pak::pkg_install(c("spelling", "urlchecker", "devtools"))

        # Spelling check
        message("=== Spelling Check ===")
        spell_errors <- spelling::spell_check_package()
        if (nrow(spell_errors) > 0) {
          print(spell_errors)
          message("Add valid words to inst/WORDLIST")
        }

        # URL check
        message("=== URL Check ===")
        url_results <- urlchecker::url_check()
        if (!is.null(url_results) && nrow(url_results) > 0) {
          print(url_results)
        }

        # Full CRAN check (NOTEs and warnings are allowed, only errors fail)
        message("=== R CMD check --as-cran ===")
        results <- devtools::check(cran = TRUE, error_on = "error")
      '
  artifacts:
    paths:
      - "*.Rcheck/"
    expire_in: 1 week
    when: always
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+/
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
      allow_failure: true

# Build source package for release
build-package:
  stage: deploy
  timeout: 15m
  needs:
    - job: r-cmd-check
  <<: *setup
  script:
    - |
      Rscript -e '
        options(repos = c(RSPM = Sys.getenv("RSPM"), CRAN = "https://cloud.r-project.org"))
        pak::pkg_install("devtools")
        pkg <- devtools::build()
        # Get version from DESCRIPTION
        desc <- read.dcf("DESCRIPTION")
        version <- desc[1, "Version"]
        pkg_name <- paste0("gnucashr_", version, ".tar.gz")
        file.copy(pkg, pkg_name)
        message("Built package: ", pkg_name)
      '
  artifacts:
    paths:
      - gnucashr_*.tar.gz
    expire_in: 3 months
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+/

# Create GitLab release
release:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build-package
      artifacts: true
    - job: cran-check
      artifacts: false
  script:
    - echo "Creating release for ${CI_COMMIT_TAG}"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "gnucashr ${CI_COMMIT_TAG}"
    description: |
      ## gnucashr ${CI_COMMIT_TAG}

      See NEWS.md for full changelog.

      ### Installation

      From CRAN (after acceptance):
      ```r
      install.packages("gnucashr")
      ```

      From GitLab:
      ```r
      remotes::install_gitlab("tinyland/projects/gnucashr@${CI_COMMIT_TAG}")
      ```

      From GitHub:
      ```r
      remotes::install_github("Jesssullivan/gnucashr@${CI_COMMIT_TAG}")
      ```
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/
